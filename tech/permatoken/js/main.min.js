function makeCSV(a){document.getElementById("alphaCheck").checked&&a.sort();var c,d,b=[],e=a.length;for(d=0;d<e;d++)c=a[d].replace(/'/g,"^"),b.push(c);var f=b.join("\n");return encodeURI("data:text/csv;charset=UTF-16LE,"+f)}function clearCanvases(){null!=pieChart&&pieChart.destroy(),null!=radarChart&&radarChart.destroy(),null!=fiveChart&&fiveChart.destroy(),null!=affChart&&affChart.destroy();var a=document.getElementsByTagName("canvas"),b=a.length,c=0;for(c;c<b;c++){var d=a[c].parentNode,e=document.createElement("canvas");e.id=a[c].id,e.width=400,e.height=400,e.style.width="400px",e.style.height="400px",d.removeChild(a[c]),d.appendChild(e)}}function optToggle(){var a=document.getElementById("optBox");prospectCheck.checked&&affectCheck.checked?(optimismCheck.disabled=!1,a.classList.remove("disabled")):(optimismCheck.disabled=!0,optimismCheck.checked=!1,a.classList.add("disabled"))}function loadLexicon(a,b,c){body.classList.add("loading");var d=function(a){var c;for(c in a)a.hasOwnProperty(c)&&(b[c]=a[c]);body.classList.remove("loading")},e=new XMLHttpRequest;e.open("GET",a,!0),e.onload=function(){if(!(this.status>=200&&this.status<400))return body.classList.remove("loading"),window.alert("There was an error loading the lexicon! Please refresh the page and try again."),!1;var a=JSON.parse(this.response);lexStatus[c]=!0,d(a)},e.onerror=function(){return body.classList.remove("loading"),window.alert("There was an error loading the lexicon! Please refresh the page and try again."),!1},e.send()}function tokenise(a){var b=new RegExp(/(?:(?:\+?[01][\-\s.]*)?(?:[\(]?\d{3}[\-\s.\)]*)?\d{3}[\-\s.]*\d{4})|(?:[<>]?[:;=8>][\-o\*\']?[\)\]\(\[dDpPxX\/\:\}\{@\|\\]|[\)\]\(\[dDpPxX\/\:\}\{@\|\\][\-o\*\']?[:;=8<][<>]?|<3|\(?\(?\#?\(?\(?\#?[>\-\^\*\+o\~][\_\.\|oO\,][<\-\^\*\+o\~][\#\;]?\)?\)?)|(?:(?:http[s]?\:\/\/)?(?:[\w\_\-]+\.)+(?:com|net|gov|edu|info|org|ly|be|gl|co|gs|pr|me|cc|us|gd|nl|ws|am|im|fm|kr|to|jp|sg))|(?:http[s]?\:\/\/)|(?:\[[a-z_]+\])|(?:\/\w+\?(?:\;?\w+\=\w+)+)|<[^>]+>|(?:@[\w_]+)|(?:\#+[\w_]+[\w\'_\-]*[\w_]+)|(?:[a-z][a-z'\-_]+[a-z])|(?:[+\-]?\d+[,\/.:-]\d+[+\-]?)|(?:[\w_]+)|(?:\.(?:\s*\.){1,})|(?:\S)/,"gi");return a.match(b)}function sortMatches(a,b){var c={counts:{}},d=!1,e=-999,f=999,g=permaSelect.value;"1"!==g&&"4"!==g||(d=!0,e=parseFloat(minWeight.value),f=parseFloat(maxWeight.value));var h;for(h in b)if(b.hasOwnProperty(h)){var j,i=[],k=b[h],l=h.startsWith("POS")||h.startsWith("NEG"),m=0;for(j in k)if(k.hasOwnProperty(j)){var n=k[j];if(a.indexOf(j)>-1){if(l&&d&&(n<e||n>f))continue;var o=[],p=a.indexesOf(j).length;if(m+=p,p>1){var r,q=[];for(r=0;r<p;r++)q.push(j);o.push([q,n])}else o.push([j,n]);i.push(o)}}c.counts[h]=m,c[h]=i}return c}function getWords(a,b){var d,c=[];for(d in a)if(a.hasOwnProperty(d)&&d.startsWith(b)&&"counts"!==d){var e,f=a[d];for(e in f)if(f.hasOwnProperty(e)){var g=f[e][0][0],h=0;if(Array.isArray(g)&&(h=g.length,g=f[e][0][0][0]),-1===c.indexOf(g))if(0===h)c.push(g);else{var i;for(i=0;i<h;i++)c.push(g)}}}return c}function handleDuplicates(a){var c,b={};for(c in a)if(a.hasOwnProperty(c)&&"counts"!==c){var e,d=[],f=a[c];for(e in f)if(f.hasOwnProperty(e)){var g=f[e][0][0];Array.isArray(g)?d.push(g[0]+"["+g.length+"]"):d.push(g)}d.sort(),b[c]=d}return b}function calcLex(a,b,c,d){null==c&&(c=0);var g,e=[],f=[];for(g in a)if(a.hasOwnProperty(g)){var h=a[g][0][0],i=a[g][0][1];Array.isArray(h)?e.push(h.length):e.push(1),f.push(i)}var j=0,k=e.length,l=0;for(l;l<k;l++){var m=Number(f[l]);if("freq"===d){j+=Number(e[l])/Number(b)*m}else j+=m}return j+=Number(c),Number(j)}function main(){body.classList.add("loading");var a=document.getElementById("textInput"),b=a.value.toString().trim().toLowerCase();if(0===b.length)return body.classList.remove("loading"),window.alert("Input box is empty!"),!1;document.getElementById("buttonRow").innerHTML="",document.getElementById("buttonRowBlc").innerHTML="",clearCanvases();var c=tokenise(b),d=c.length;if(document.getElementById("CSVCheck").checked){var e=makeCSV(c),f=Date.now().toString(),g=document.getElementById("buttonRow"),h=document.getElementById("buttonRowBlc"),i=document.createElement("a");i.setAttribute("href",e),i.setAttribute("download","PPTA_Tokens_"+f+".csv"),i.classList.add("btn","btn-default","btn-lg"),i.innerHTML="Save CSV";var j=document.createElement("a");j.setAttribute("href",e),j.setAttribute("download","PPTA_Tokens_"+f+".csv"),j.classList.add("btn","btn-default","btn-block"),g.appendChild(i),h.appendChild(j)}var k={},l=permaSelect.value;k="4"===l?sortMatches(c,permaSLex):"2"===l?sortMatches(c,permaMLex):"3"===l?sortMatches(c,permaTLex):sortMatches(c,permaDLex),k.counts.POS_T=getWords(k,"POS").length,k.counts.NEG_T=getWords(k,"NEG").length,k.counts.TOTAL=getWords(k,"").length;var m;m="4"===l?{POS_P:2.675173871,POS_E:2.055179283,POS_R:1.977389757,POS_M:1.738298902,POS_A:3.414517804,NEG_P:2.50468297,NEG_E:1.673629622,NEG_R:1.782788984,NEG_M:1.52890284,NEG_A:2.482131179}:{POS_P:0,POS_E:0,POS_R:0,POS_M:0,POS_A:0,NEG_P:0,NEG_E:0,NEG_R:0,NEG_M:0,NEG_A:0};var n={};n.POS_P=calcLex(k.POS_P,d,m.POS_P,"binary").toFixed(6),n.POS_E=calcLex(k.POS_E,d,m.POS_E,"binary").toFixed(6),n.POS_R=calcLex(k.POS_R,d,m.POS_R,"binary").toFixed(6),n.POS_M=calcLex(k.POS_M,d,m.POS_M,"binary").toFixed(6),n.POS_A=calcLex(k.POS_A,d,m.POS_A,"binary").toFixed(6),n.NEG_P=calcLex(k.NEG_P,d,m.NEG_P,"binary").toFixed(6),n.NEG_E=calcLex(k.NEG_E,d,m.NEG_E,"binary").toFixed(6),n.NEG_R=calcLex(k.NEG_R,d,m.NEG_R,"binary").toFixed(6),n.NEG_M=calcLex(k.NEG_M,d,m.NEG_M,"binary").toFixed(6),n.NEG_A=calcLex(k.NEG_A,d,m.NEG_A,"binary").toFixed(6);var r,o=handleDuplicates(k),p={},q={};prospectCheck.checked&&(p=sortMatches(c,prospLex),p.counts.TOTAL=getWords(p,"").length,q.PAST=calcLex(p.PAST,d,-.649406376419,"binary").toFixed(6),q.PRESENT=calcLex(p.PRESENT,d,.236749577324,"binary").toFixed(6),q.FUTURE=calcLex(p.FUTURE,d,-.570547567181,"binary").toFixed(6),r=handleDuplicates(p));var u,s={},t={};if(affectCheck.checked){s=sortMatches(c,affLex),t.AFFECT=calcLex(s.AFFECT,d,5.037104721,"binary").toFixed(3),t.INTENSITY=calcLex(s.INTENSITY,d,2.399762631,"binary").toFixed(3),u=handleDuplicates(s),t.AFFECT>9&&(t.AFFECT=9),t.INTENSITY>9&&(t.INTENSITY=9),t.AFFECT<1&&(t.AFFECT=1),t.INTENSITY<1&&(t.INTENSITY=1);var v={datasets:[{label:"Affect / Intensity",data:[{x:t.AFFECT,y:t.INTENSITY,r:5}],backgroundColor:"#FF6384",hoverBackgroundColor:"#FF6384"}]},w={scales:{yAxes:[{ticks:{max:9,min:1,stepSize:1},scaleLabel:{display:!0,labelString:"Intensity"}}],xAxes:[{ticks:{max:9,min:1,stepSize:1},scaleLabel:{display:!0,labelString:"Affect"}}]}},x=document.getElementById("affBubble").getContext("2d");affChart=new Chart(x,{type:"bubble",data:v,options:w})}var A,y={},z={};if(optimismCheck.checked){y=sortMatches(getWords(p,"FUTURE"),affLex),z=calcLex(y.AFFECT,d,5.037104721,"binary").toFixed(3),A=handleDuplicates(y)}var E,C={},D={};if(bigFiveCheck.checked){C=sortMatches(c,big5Lex),C.counts.TOTAL=getWords(C,"").length,D.O=calcLex(C.O,d,0,"binary").toFixed(6),D.C=calcLex(C.C,d,0,"binary").toFixed(6),D.E=calcLex(C.E,d,0,"binary").toFixed(6),D.A=calcLex(C.A,d,0,"binary").toFixed(6),D.N=calcLex(C.N,d,0,"binary").toFixed(6),E=handleDuplicates(C);var F={labels:["Openness","Conscientiousness","Extraversion","Agreeableness","Neuroticism"],datasets:[{label:"Big Five Personality Traits",backgroundColor:"rgba(119, 221, 119,0.2)",borderColor:"#77dd77",pointBackgroundColor:"rgba(179,181,198,1)",pointBorderColor:"#fff",pointHoverBackgroundColor:"#fff",pointHoverBorderColor:"#77dd77",data:[D.O,D.C,D.E,D.A,D.N]},{label:"Zero",backgroundColor:"rgba(0, 0, 0, 0)",borderColor:"#000",pointBackgroundColor:"rgba(0,0,0,1)",pointBorderColor:"#fff",pointHoverBackgroundColor:"#fff",pointHoverBorderColor:"#000",data:[0,0,0,0,0]}]},G=document.getElementById("fiveRadar").getContext("2d");fiveChart=new Chart(G,{type:"radar",data:F})}var H={},I={};ageCheck.checked&&(H=sortMatches(c,ageLex),I=calcLex(H.AGE,d,23.2188604687,"freq").toFixed(2));var J={},K={};genderCheck.checked&&(J=sortMatches(c,genderLex),K=calcLex(J.GENDER,d,-.06724152,"freq").toFixed(3));var L=d-k.counts.TOTAL,M=(k.counts.TOTAL/d*100).toFixed(2),N=(L/d*100).toFixed(2),O=document.getElementById("permaPie").getContext("2d"),P=document.getElementById("permaRad").getContext("2d"),Q={labels:["Positive","Negative"],datasets:[{data:[k.counts.POS_T,k.counts.NEG_T],backgroundColor:["#77dd77","#FF6384"],hoverBackgroundColor:["#77dd77","#FF6384"]}]},R={labels:["Emotion","Engagement","Relationships","Meaning","Accomplishment"],datasets:[{label:"Positive",backgroundColor:"rgba(119, 221, 119,0.2)",borderColor:"#77dd77",pointBackgroundColor:"rgba(179,181,198,1)",pointBorderColor:"#fff",pointHoverBackgroundColor:"#fff",pointHoverBorderColor:"#77dd77",data:[n.POS_P,n.POS_E,n.POS_R,n.POS_M,n.POS_A]},{label:"Negative",backgroundColor:"rgba(255,99,132,0.2)",borderColor:"rgba(255,99,132,1)",pointBackgroundColor:"rgba(255,99,132,1)",pointBorderColor:"#fff",pointHoverBackgroundColor:"#fff",pointHoverBorderColor:"rgba(255,99,132,1)",data:[n.NEG_P,n.NEG_E,n.NEG_R,n.NEG_M,n.NEG_A]},{label:"Zero",backgroundColor:"rgba(0, 0, 0, 0)",borderColor:"#000",pointBackgroundColor:"rgba(0,0,0,1)",pointBorderColor:"#fff",pointHoverBackgroundColor:"#fff",pointHoverBorderColor:"#000",data:[0,0,0,0,0]}]};pieChart=new Chart(O,{type:"pie",data:Q}),radarChart=new Chart(P,{type:"radar",data:R});var S="";if(0===k.counts.POS_T||0===k.counts.NEG_T?k.counts.POS_T<k.counts.NEG_T?S="Of the matches, 100% were negative PERMA matches.":k.counts.POS_T>k.counts.NEG_T?S="Of the matches, 100% were positive PERMA matches.":k.counts.POS_T===k.counts.NEG_T&&(S="There were no PERMA matches in the input."):k.counts.POS_T<k.counts.NEG_T?S="For every positive PERMA match there are "+(k.counts.NEG_T/k.counts.POS_T).toFixed(3)+" times as many negative PERMA matches.":k.counts.POS_T>k.counts.NEG_T?S="For every negative PERMA match there are "+(k.counts.POS_T/k.counts.NEG_T).toFixed(3)+" times as many positive PERMA matches.":k.counts.POS_T===k.counts.NEG_T&&(S="There are an equal number of + and - PERMA matches."),document.getElementById("wordcount").textContent=d,document.getElementById("matches").textContent=k.counts.TOTAL+" ("+M+"%)",document.getElementById("pmatches").textContent=k.counts.POS_T,document.getElementById("nmatches").textContent=k.counts.NEG_T,document.getElementById("umatches").textContent=L+" ("+N+"%)",document.getElementById("ratio").textContent=S,"1"===l||"4"===l?(document.getElementById("lex").classList.remove("hidden"),document.getElementById("ppl").textContent=n.POS_P,document.getElementById("pel").textContent=n.POS_E,document.getElementById("prl").textContent=n.POS_R,document.getElementById("pml").textContent=n.POS_M,document.getElementById("pal").textContent=n.POS_A,document.getElementById("npl").textContent=n.NEG_P,document.getElementById("nel").textContent=n.NEG_E,document.getElementById("nrl").textContent=n.NEG_R,document.getElementById("nml").textContent=n.NEG_M,document.getElementById("nal").textContent=n.NEG_A,document.getElementById("permaRadar").classList.remove("hidden")):(document.getElementById("lex").classList.add("hidden"),document.getElementById("permaRadar").classList.add("hidden")),document.getElementById("posP").textContent=o.POS_P.join(", "),document.getElementById("negP").textContent=o.NEG_P.join(", "),document.getElementById("posE").textContent=o.POS_E.join(", "),document.getElementById("negE").textContent=o.NEG_E.join(", "),document.getElementById("posR").textContent=o.POS_R.join(", "),document.getElementById("negR").textContent=o.NEG_R.join(", "),document.getElementById("posM").textContent=o.POS_M.join(", "),document.getElementById("negM").textContent=o.NEG_M.join(", "),document.getElementById("posA").textContent=o.POS_A.join(", "),document.getElementById("negA").textContent=o.NEG_A.join(", "),prospectCheck.checked&&(document.getElementById("prospectRes").classList.remove("hidden"),document.getElementById("prospTotal").textContent=p.counts.TOTAL,document.getElementById("prospPast").textContent=p.counts.PAST,document.getElementById("prospPresent").textContent=p.counts.PRESENT,document.getElementById("prospFuture").textContent=p.counts.FUTURE,document.getElementById("pastLex").textContent=q.PAST,document.getElementById("presLex").textContent=q.PRESENT,document.getElementById("futrLex").textContent=q.FUTURE,document.getElementById("past").textContent=r.PAST.join(", "),document.getElementById("present").textContent=r.PRESENT.join(", "),document.getElementById("future").textContent=r.FUTURE.join(", ")),affectCheck.checked&&(document.getElementById("affectRes").classList.remove("hidden"),document.getElementById("affTotal").textContent=s.counts.AFFECT,document.getElementById("affLex").textContent=t.AFFECT,document.getElementById("intLex").textContent=t.INTENSITY,document.getElementById("affPrint").textContent=u.AFFECT.join(", ")),optimismCheck.checked&&(document.getElementById("optimRes").classList.remove("hidden"),document.getElementById("optTotal").textContent=y.counts.AFFECT,document.getElementById("optLex").textContent=z,document.getElementById("optPrint").textContent=A.AFFECT.join(", ")),ageCheck.checked&&(document.getElementById("ageRes").classList.remove("hidden"),document.getElementById("predAge").textContent=I),genderCheck.checked){document.getElementById("genRes").classList.remove("hidden");var T="Unknown";K<0?T="Male":K>0&&(T="Female"),document.getElementById("predGen").textContent=T,document.getElementById("genLex").textContent=K}bigFiveCheck.checked&&(document.getElementById("fiveRes").classList.remove("hidden"),document.getElementById("fiveTotal").textContent=C.counts.TOTAL,document.getElementById("oLex").textContent=D.O,document.getElementById("cLex").textContent=D.C,document.getElementById("eLex").textContent=D.E,document.getElementById("aLex").textContent=D.A,document.getElementById("nLex").textContent=D.N,document.getElementById("oPrint").textContent=E.O.join(", "),document.getElementById("cPrint").textContent=E.C.join(", "),document.getElementById("ePrint").textContent=E.E.join(", "),document.getElementById("aPrint").textContent=E.A.join(", "),document.getElementById("nPrint").textContent=E.N.join(", ")),document.getElementById("noContent").classList.add("hidden"),document.getElementById("outputSection").classList.remove("hidden"),document.getElementById("results").classList.add("active"),document.getElementById("inputSection").classList.remove("active"),document.getElementById("rTab").classList.add("active"),document.getElementById("iTab").classList.remove("active"),body.classList.remove("loading"),window.scrollTo(0,0)}var permaDLex={},permaMLex={},permaTLex={},permaSLex={},prospLex={},affLex={},ageLex={},genderLex={},big5Lex={},lexStatus={dLoaded:!1,mLoaded:!1,tLoaded:!1,sLoaded:!1,pLoaded:!1,aLoaded:!1,gLoaded:!1,eLoaded:!1,"5Loaded":!1},body=document.getElementsByTagName("body")[0],prospectCheck=document.getElementById("prospectCheck"),affectCheck=document.getElementById("affectCheck"),optimismCheck=document.getElementById("optimismCheck"),bigFiveCheck=document.getElementById("bigFiveCheck"),ageCheck=document.getElementById("ageCheck"),genderCheck=document.getElementById("genderCheck"),minWeight=document.getElementById("minWeight"),maxWeight=document.getElementById("maxWeight"),permaSelect=document.getElementById("permaSelect"),pieChart,radarChart,fiveChart,affChart;Array.prototype.indexesOf=function(a){var b=[],c=this.length-1;for(c;c>=0;c--)this[c]===a&&b.unshift(c);return b},Array.prototype.containsArray=function(a){var b={},c=0,d=this.length;for(c;c<d;c++)b[this[c]]=c;return b.hasOwnProperty(a)},document.addEventListener("DOMContentLoaded",function(){loadLexicon("json/perma/permaV3_dd.json",permaDLex,"dLoaded");var b=document.getElementsByClassName("startButton");if(b[0].addEventListener("click",main,!1),b[1].addEventListener("click",main,!1),permaSelect.addEventListener("change",function(){var a=permaSelect.value;"1"===a?(!1===lexStatus.dLoaded&&loadLexicon("json/perma/permaV3_dd.json",permaDLex,"dLoaded"),minWeight.disabled=!1,maxWeight.disabled=!1,minWeight.value=-.38,maxWeight.value=.86,minWeight.min=-.38,maxWeight.max=.86):"2"===a?(!1===lexStatus.mLoaded&&loadLexicon("json/perma/permaV3_manual.json",permaMLex,"mLoaded"),minWeight.disabled=!0,maxWeight.disabled=!0):"3"===a?(!1===lexStatus.tLoaded&&loadLexicon("json/perma/permaV3_manual_tsp75.json",permaTLex,"tLoaded"),minWeight.disabled=!0,maxWeight.disabled=!0):"4"===a?(!1===lexStatus.sLoaded&&loadLexicon("json/perma/dd_spermaV3.json",permaSLex,"sLoaded"),minWeight.disabled=!1,maxWeight.disabled=!1,minWeight.value=-.86,maxWeight.value=3.35,minWeight.min=-.86,maxWeight.max=3.35):(console.error("#permaSelect: invalid selection. Defaulting to 1."),permaSelect.value="1")},{passive:!0}),prospectCheck.addEventListener("click",function(){prospectCheck.checked&&!1===lexStatus.pLoaded&&loadLexicon("json/prospection/prospection.json",prospLex,"pLoaded"),optToggle()},{passive:!0}),affectCheck.addEventListener("click",function(){affectCheck.checked&&!1===lexStatus.aLoaded&&loadLexicon("json/affect/affect.json",affLex,"aLoaded"),optToggle()},{passive:!0}),document.getElementById("CSVCheck").addEventListener("click",function(){var a=document.getElementById("alphaCSV"),b=document.getElementById("alphaCheck");a.classList.contains("disabled")?(a.classList.remove("disabled"),b.disabled=!1):(a.classList.add("disabled"),b.disabled=!0)},{passive:!0}),ageCheck.addEventListener("click",function(){ageCheck.checked&&!1===lexStatus.eLoaded&&loadLexicon("json/age/age.json",ageLex,"eLoaded")},{passive:!0,once:!0}),genderCheck.addEventListener("click",function(){genderCheck.checked&&!1===lexStatus.gLoaded&&loadLexicon("json/gender/gender.json",genderLex,"gLoaded")},{passive:!0,once:!0}),bigFiveCheck.addEventListener("click",function(){bigFiveCheck.checked&&!1===lexStatus["5Loaded"]&&loadLexicon("json/bigfive/bigfive.json",big5Lex,"5Loaded")},{passive:!0,once:!0}),setTimeout(function(){$('[data-toggle="popover"]').popover(),$(".collapse").collapse()},700),Chart.defaults.global.responsive=!1,Chart.defaults.global.maintainAspectRatio=!1,navigator.userAgent.match(/IEMobile\/10\.0/)){var c=document.createElement("style");c.appendChild(document.createTextNode("@-ms-viewport{width:auto!important}")),document.querySelector("head").appendChild(c)}},{passive:!0,once:!0});